{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- import css file -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
    <link rel="stylesheet" href="{% static 'mainapp/css/style.css'%}?v=1">

    <title>Claim Your Rekord</title>
</head>
<body>

    <!-- navbar section -->
    <nav class="navbar navbar-expand-lg bg-body-tertiary">
        <div class="container-fluid">
            <a class="navbar-brand">REKORD</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarSupportedContent">
                <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                    <li class="nav-item">
                        <a class="nav-link active" href="#">Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="#">Wallet</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="#">Help</a>
                    </li>
                </ul>
                <a href="/" class="btn btn-outline-danger">Log Out</a>
            </div>
        </div>
    </nav>

    <!-- title section -->
    <div>
        <h1 class="claim-title text-center">hey <span class="participant-name">{{claimtoken.name}}!!!</span></h1>
        <h4 class="caption text-center">--let's mint a badge on chain--</h4>
        
        <div class="dynamicdiv">
            <div class="d-flex justify-content-center mb-3">
                <button type="button" class="btn connect-btn w-25" name="action" value="connect-wallet" id="connectwalletbutton">Connect Wallet</button>
            </div>
            <p id="walletAddress" class="nowalletaddr text-center"> No Wallet Connected</p>
        </div>
        {% comment %}
            <p class="claim-subtitle text-center mt-5">you have a Rekord to mint. Not everyone get's one, so </p>
            <p class="claim-subtitle text-center">claim you're right now!!</p>
        {% endcomment %}
    </div>

    
    <div class="display-tile align-item-start">
        <div class="d-flex align-item-center gap-5">
            <div class="imagediv d-flex justify-content-center">
                <img class="claim-imagepreview" id="image-preview" src="/media/{{event.eventicon}}" alt="Image Preview">
            </div>
            <div>
                <p class="claim-eventname">{{event.eventname}}</p>

                <p class="claim-event">Event Name</p>
                <p class="claim-event">Event Name</p>

                <div class="d-flex justify-content-center gap-5">
                    <p class="claim-event">City: {{event.city}}</p>
                    <p class="claim-eventdate">Date: {{event.eventdate}}</p>
                </div>
            </div>
        </div>
        <form method="POST">
            {% csrf_token %}
            <input type="hidden" id="walletInput" name="walletaddress">
            <button type="submit" class="btn claim-btn-green w-50 mt-3" disabled name="action" value="mint-badge" id="mintbadge">Mint NFT</button>
        </form>
    </div>
    





    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <script>
        const walletBtn = document.getElementById("connectwalletbutton");
        const walletText = document.getElementById("walletAddress");
        const walletInput = document.getElementById("walletInput");
        const mintBtn = document.getElementById("mintbadge");

        let provider = null;
        let signer = null;
        let connectedAddress = null;

        async function connectWallet() {
            if (!window.ethereum) {
                alert("MetaMask not detected. Please install MetaMask.");
                return;
            }

            provider = new ethers.providers.Web3Provider(window.ethereum);
            await provider.send("eth_requestAccounts", []);
            signer = provider.getSigner();
            connectedAddress = await signer.getAddress();

            // UI update
            walletText.innerText = `Connected to : ${connectedAddress}`;
            walletText.classList.remove("nowalletaddr");
            walletText.classList.add("yeswalletaddr");
            walletInput.value = connectedAddress;
            console.log("Hidden input set to:", walletInput.value);
            mintBtn.disabled = false;

            walletBtn.innerText = "Disconnect Wallet";
            walletBtn.classList.remove("connect-btn");
            walletBtn.classList.add("disconnect-btn");

            walletBtn.onclick = disconnectWallet;
        }

        function disconnectWallet() {
            provider = null;
            signer = null;
            connectedAddress = null;

            walletText.innerText = "No Wallet Connected";
            walletInput.value = "";

            walletBtn.innerText = "Connect Wallet";
            walletBtn.classList.remove("disconnect-btn");
            walletBtn.classList.add("connect-btn");

            walletBtn.onclick = connectWallet;
        }

        // Initial binding
        walletBtn.onclick = connectWallet;
    </script>

</body>
</html>